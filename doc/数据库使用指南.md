# æ•°æ®åº“ä½¿ç”¨æŒ‡å—

åŸºäº `doc/æ•°æ®åº“è®¾è®¡.md` æ„å»ºçš„æ•°æ®åº“å±‚ï¼Œä½¿ç”¨ SQLite + Better-SQLite3 + Kysely å®ç°ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/db/
â”œâ”€â”€ database.ts          # æ•°æ®åº“è¿æ¥å•ä¾‹
â”œâ”€â”€ schema.ts           # ç±»å‹å®šä¹‰å’Œè¡¨ç»“æ„
â”œâ”€â”€ models.ts           # æ•°æ®æ¨¡å‹æ“ä½œç±»
â”œâ”€â”€ migrate.ts          # è¿ç§»ç®¡ç†å™¨
â””â”€â”€ migrations/         # è¿ç§»æ–‡ä»¶
    â”œâ”€â”€ 001_create_users_table.sql
    â”œâ”€â”€ 002_create_projects_table.sql
    â”œâ”€â”€ 003_create_chapters_table.sql
    â”œâ”€â”€ 004_create_chapter_versions_table.sql
    â”œâ”€â”€ 005_create_world_books_table.sql
    â””â”€â”€ 006_create_characters_table.sql
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ•°æ®åº“

```bash
# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆåˆ›å»ºè¡¨ç»“æ„ï¼‰
npm run db:init

# æˆ–ç›´æ¥è¿è¡Œè¿ç§»
npm run db:migrate
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ•°æ®åº“æµ‹è¯•
npm run db:test
```

### 3. é‡ç½®æ•°æ®åº“

```bash
# åˆ é™¤æ•°æ®åº“æ–‡ä»¶å¹¶é‡æ–°åˆå§‹åŒ–
npm run db:reset
```

## ğŸ”§ é…ç½®

æ•°æ®åº“æ–‡ä»¶é»˜è®¤å­˜å‚¨åœ¨ `data/novelcraft.db`ã€‚å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ä¿®æ”¹ï¼š

```bash
# è®¾ç½®è‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„
export DATABASE_PATH=/path/to/your/database.db
```

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### 1. `users` (ç®¡ç†å‘˜è´¦æˆ·)
- `id`: ä¸»é”®ï¼Œè‡ªå¢
- `username`: å”¯ä¸€ç”¨æˆ·åï¼ˆé‚®ç®±æ ¼å¼ï¼‰
- `password_hash`: bcrypt å“ˆå¸Œå¯†ç 
- `auth_method`: è®¤è¯æ–¹å¼ï¼ˆpassword/passkeyï¼‰
- `passkey_credential`: WebAuthn å‡­è¯
- `last_login_at`: æœ€åç™»å½•æ—¶é—´
- `created_at`, `updated_at`: æ—¶é—´æˆ³

### 2. `projects` (å°è¯´é¡¹ç›®)
- `id`: ä¸»é”®ï¼Œè‡ªå¢
- `user_id`: å¤–é”® â†’ users(id)
- `title`: é¡¹ç›®æ ‡é¢˜
- `description`: é¡¹ç›®æè¿°
- `status`: çŠ¶æ€ï¼ˆactive/archivedï¼‰
- `current_chapter_id`: å½“å‰ç¼–è¾‘ç« èŠ‚
- `created_at`, `updated_at`: æ—¶é—´æˆ³
- `deleted_at`: è½¯åˆ é™¤æ—¶é—´

### 3. `chapters` (ç« èŠ‚)
- `id`: ä¸»é”®ï¼Œè‡ªå¢
- `project_id`: å¤–é”® â†’ projects(id)
- `title`: ç« èŠ‚æ ‡é¢˜
- `content`: å½“å‰ç”Ÿæ•ˆå†…å®¹
- `version_seq`: å½“å‰ç‰ˆæœ¬åºå·
- `word_count`: å­—æ•°ç»Ÿè®¡
- `agent_trace`: Agent å·¥ä½œæµæ‘˜è¦ï¼ˆJSONï¼‰
- `created_at`, `updated_at`: æ—¶é—´æˆ³
- `deleted_at`: è½¯åˆ é™¤æ—¶é—´

### 4. `chapter_versions` (ç« èŠ‚å†å²ç‰ˆæœ¬)
- `id`: ä¸»é”®ï¼Œè‡ªå¢
- `chapter_id`: å¤–é”® â†’ chapters(id) ON DELETE CASCADE
- `version_number`: ç‰ˆæœ¬å·ï¼ˆ1~10ï¼‰
- `content`: è¯¥ç‰ˆæœ¬å®Œæ•´å†…å®¹
- `created_by_agent`: ç”ŸæˆAgentè§’è‰²
- `created_at`: ä¿å­˜æ—¶é—´
- å”¯ä¸€çº¦æŸï¼š`(chapter_id, version_number)`

### 5. `world_books` (ä¸–ç•Œè®¾å®š)
- `id`: ä¸»é”®ï¼Œè‡ªå¢
- `project_id`: å¤–é”® â†’ projects(id) ON DELETE CASCADEï¼ˆå”¯ä¸€ï¼‰
- `content`: Markdown æ ¼å¼ä¸–ç•Œè§‚
- `outline`: ç»“æ„åŒ–æ‘˜è¦ï¼ˆJSONï¼‰
- `created_at`, `updated_at`: æ—¶é—´æˆ³

### 6. `characters` (è§’è‰²å¡)
- `id`: ä¸»é”®ï¼Œè‡ªå¢
- `project_id`: å¤–é”® â†’ projects(id) ON DELETE CASCADE
- `name`: è§’è‰²å
- `alias`: åˆ«å/ç§°å·
- `description`: è¯¦ç»†è®¾å®š
- `avatar_url`: å¤´åƒè·¯å¾„
- `tags`: æ ‡ç­¾ï¼ˆJSON æ•°ç»„ï¼‰
- `created_at`, `updated_at`: æ—¶é—´æˆ³
- `deleted_at`: è½¯åˆ é™¤æ—¶é—´

## ğŸ’» ä»£ç ä½¿ç”¨ç¤ºä¾‹

### è·å–æ•°æ®åº“è¿æ¥

```typescript
import { getDb } from './src/db/database';

const db = getDb();
```

### ä½¿ç”¨æ¨¡å‹ç±»

```typescript
import { Models } from './src/db/models';

// åˆ›å»ºç”¨æˆ·
const user = await Models.users.create({
  username: 'admin@example.com',
  password_hash: 'hashed_password',
  auth_method: 'password',
});

// æŸ¥è¯¢é¡¹ç›®
const projects = await Models.projects.findByUserId(user.id);

// åˆ›å»ºç« èŠ‚
const chapter = await Models.chapters.create({
  project_id: project.id,
  title: 'ç¬¬ä¸€ç« ',
  content: 'ç« èŠ‚å†…å®¹...',
});

// åˆ›å»ºç« èŠ‚ç‰ˆæœ¬
await Models.chapterVersions.create({
  chapter_id: chapter.id,
  version_number: 1,
  content: 'ç‰ˆæœ¬å†…å®¹...',
  created_by_agent: 'writer',
});
```

### ç›´æ¥ä½¿ç”¨ Kysely æŸ¥è¯¢

```typescript
import { getDb } from './src/db/database';
import { sql } from 'kysely';

const db = getDb();

// å¤æ‚æŸ¥è¯¢ç¤ºä¾‹
const results = await db
  .selectFrom('projects')
  .innerJoin('users', 'users.id', 'projects.user_id')
  .select([
    'projects.id',
    'projects.title',
    'users.username',
    sql<number>`COUNT(chapters.id)`.as('chapter_count')
  ])
  .leftJoin('chapters', 'chapters.project_id', 'projects.id')
  .where('projects.deleted_at', 'is', null)
  .groupBy('projects.id')
  .execute();
```

## ğŸ”’ ç‰¹æ€§è¯´æ˜

### è½¯åˆ é™¤æœºåˆ¶
- æ‰€æœ‰ä¸»å®ä½“è¡¨ï¼ˆprojects, chapters, charactersï¼‰åŒ…å« `deleted_at` å­—æ®µ
- æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤ `WHERE deleted_at IS NULL`
- æ¢å¤æ—¶è®¾ç½® `deleted_at = NULL`

### å¤–é”®çº¦æŸ
- åˆå§‹åŒ–æ—¶è‡ªåŠ¨å¯ç”¨ `PRAGMA foreign_keys = ON`
- æ”¯æŒçº§è”åˆ é™¤ï¼ˆON DELETE CASCADEï¼‰
- ç¡®ä¿æ•°æ®å®Œæ•´æ€§

### æ€§èƒ½ä¼˜åŒ–
- å¯ç”¨ WAL æ¨¡å¼ï¼ˆPRAGMA journal_mode = WALï¼‰
- é«˜é¢‘æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•
- `chapters.word_count` é¢„è®¡ç®—å­—æ•°

### ç« èŠ‚ç‰ˆæœ¬æ§åˆ¶
- `chapters` è¡¨å­˜å‚¨å½“å‰ç”Ÿæ•ˆç‰ˆæœ¬
- `chapter_versions` è¡¨å­˜å‚¨å†å²ç‰ˆæœ¬ï¼ˆæœ€å¤š10ä¸ªï¼‰
- åº”ç”¨å±‚è‡ªåŠ¨ç®¡ç†ç‰ˆæœ¬å¾ªç¯

## ğŸ§ª æµ‹è¯•

æ•°æ®åº“æµ‹è¯•è„šæœ¬ä½äº `test/db.test.ts`ï¼ŒåŒ…å«ï¼š
- å»ºè¡¨éªŒè¯
- å¢åˆ æ”¹æŸ¥æ“ä½œæµ‹è¯•
- å¤–é”®çº¦æŸæµ‹è¯•
- è½¯åˆ é™¤æœºåˆ¶æµ‹è¯•
- çº§è”åˆ é™¤æµ‹è¯•

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¼€å‘ç¯å¢ƒ**ï¼šæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“ï¼Œä¸ä¼šå½±å“ç”Ÿäº§æ•°æ®
2. **è¿ç§»ç®¡ç†**ï¼šè¿ç§»æ–‡ä»¶æŒ‰æ•°å­—å‰ç¼€æ’åºæ‰§è¡Œï¼Œè¯·å‹¿ä¿®æ”¹å·²åº”ç”¨çš„è¿ç§»
3. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript ç±»å‹å®šä¹‰ï¼Œç¡®ä¿ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
4. **è¿æ¥ç®¡ç†**ï¼šæ•°æ®åº“è¿æ¥ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œé¿å…é‡å¤åˆ›å»ºè¿æ¥

## ğŸ”„ æ·»åŠ æ–°è¿ç§»

1. åœ¨ `src/db/migrations/` ç›®å½•åˆ›å»ºæ–°çš„ SQL æ–‡ä»¶ï¼Œå¦‚ `007_add_new_column.sql`
2. æ–‡ä»¶åæŒ‰æ•°å­—é¡ºåºå‘½å
3. è¿è¡Œ `npm run db:migrate` åº”ç”¨æ–°è¿ç§»

## ğŸ†˜ æ•…éšœæ’é™¤

### æ•°æ®åº“æ–‡ä»¶æƒé™é—®é¢˜
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la data/novelcraft.db

# ä¿®æ”¹æƒé™
chmod 644 data/novelcraft.db
```

### è¿ç§»å¤±è´¥
```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npm run db:init

# æ‰‹åŠ¨æ‰§è¡Œ SQL è¯­å¥
sqlite3 data/novelcraft.db < src/db/migrations/xxx.sql
```

### ç±»å‹é”™è¯¯
ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š
```bash
npm install
npm install --save-dev @types/better-sqlite3