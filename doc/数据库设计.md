

# 数据库表设计

基于需求文档分析，设计以下7张核心表，兼顾**软删除回收站机制**、**章节版本控制**、**多租户安全**与**审计追踪**。所有时间字段使用 `DATETIME`（ISO 8601 格式），外键约束在应用层 + SQLite PRAGMA 启用保障。

## 📊 核心表结构

### 1. `users`（管理员账户）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 用户唯一ID |
| `username` | TEXT | UNIQUE NOT NULL | 登录用户名（邮箱格式） |
| `password_hash` | TEXT | NOT NULL | bcrypt 哈希（成本因子≥12） |
| `auth_method` | TEXT | DEFAULT 'password' | 认证方式：`password` / `passkey` |
| `passkey_credential` | TEXT | | WebAuthn 凭证（JSON，Google Passkey 可选） |
| `last_login_at` | DATETIME | | 最后登录时间 |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 账户创建时间 |
| `updated_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 信息更新时间 |

> 🔒 安全提示：密码绝不明文存储；Passkey 字段仅当启用时填充

---

### 2. `projects`（小说项目）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 项目ID |
| `user_id` | INTEGER | NOT NULL, FOREIGN KEY → users(id) | 所属管理员 |
| `title` | TEXT | NOT NULL | 项目标题 |
| `description` | TEXT | | 项目简介 |
| `status` | TEXT | DEFAULT 'active' | 状态：`active` / `archived` |
| `current_chapter_id` | INTEGER | FOREIGN KEY → chapters(id) | 当前编辑章节（快速定位） |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 最后修改时间 |
| `deleted_at` | DATETIME | | 软删除时间（回收站依据） |

---

### 3. `chapters`（章节 - 当前活跃版本）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 章节ID |
| `project_id` | INTEGER | NOT NULL, FOREIGN KEY → projects(id) | 所属项目 |
| `title` | TEXT | NOT NULL | 章节标题 |
| `content` | TEXT | NOT NULL | **当前生效内容**（最新版） |
| `version_seq` | INTEGER | DEFAULT 1 | 当前版本序号（与 history 衔接） |
| `word_count` | INTEGER | DEFAULT 0 | 字数统计（提升性能） |
| `agent_trace` | TEXT | | Agent 工作流摘要（JSON：`{"writer":"...","reviewer":"..."}`） |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 首次创建时间 |
| `updated_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 内容最后更新时间 |
| `deleted_at` | DATETIME | | 软删除时间 |

---

### 4. `chapter_versions`（章节历史版本）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 版本ID |
| `chapter_id` | INTEGER | NOT NULL, FOREIGN KEY → chapters(id) ON DELETE CASCADE | 关联章节 |
| `version_number` | INTEGER | NOT NULL | 版本号（1~10循环覆盖） |
| `content` | TEXT | NOT NULL | 该版本完整内容 |
| `created_by_agent` | TEXT | | 生成Agent角色（`writer`/`compressor`） |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 保存时间（精确到秒，日志文件命名依据） |
| `UNIQUE(chapter_id, version_number)` | - | - | 防止重复版本 |

> 🔄 应用层逻辑：保存新版本时，若已达10条，自动替换最旧版本（`MIN(version_number)`）

---

### 5. `world_books`（世界设定）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 世界书ID |
| `project_id` | INTEGER | UNIQUE NOT NULL, FOREIGN KEY → projects(id) ON DELETE CASCADE | 一对一关联项目 |
| `content` | TEXT | NOT NULL | Markdown 格式世界观全文 |
| `outline` | TEXT | | 结构化摘要（JSON：地理/历史/势力等） |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

---

### 6. `characters`（角色卡）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 角色ID |
| `project_id` | INTEGER | NOT NULL, FOREIGN KEY → projects(id) ON DELETE CASCADE | 所属项目 |
| `name` | TEXT | NOT NULL | 角色名 |
| `alias` | TEXT | | 别名/称号 |
| `description` | TEXT | NOT NULL | 详细设定（含外貌、性格、背景） |
| `avatar_url` | TEXT | | 头像存储路径（本地/CDN） |
| `tags` | TEXT | | 标签（JSON 数组：`["主角","法师"]`） |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |
| `deleted_at` | DATETIME | | 软删除时间 |

---


## 🔑 关键设计说明

| 特性 | 实现方案 | 需求对应 |
|------|----------|----------|
| **回收站机制** | 所有主实体表含 `deleted_at`，查询时过滤 `WHERE deleted_at IS NULL`；恢复时置 NULL | “非直接删除” |
| **章节版本控制** | `chapters` 存当前版 + `chapter_versions` 存历史（应用层维护≤10条） | “每章支持10个历史版本” |
| **Agent 协作追踪** | `chapters.agent_trace` + `chapter_versions.created_by_agent` | 多Agent工作流透明化 |
| **性能优化** | `chapters.word_count` 预计算；外键字段建索引（project_id, chapter_id） | 前端高性能要求 |
| **Passkey 支持** | `users.passkey_credential` 字段预留 | “可选Google Passkey集成” |

> 💡 **实施建议**  
> 1. 初始化时执行 `PRAGMA foreign_keys = ON;`  
> 2. 为 `deleted_at`, `project_id`, `created_at` 等高频查询字段添加索引  
> 3. 软删除清理：定期归档 `deleted_at < NOW() - 30 DAYS` 的数据  
